---
# 1. ConfigMap - å­˜æ”¾é…ç½®æ–‡ä»¶å’Œé»˜è®¤ç»´æŠ¤é¡µé¢
apiVersion: v1
kind: ConfigMap
metadata:
  name: traffic-switcher-config
  namespace: monitoring           # å»ºè®®ä¿®æ”¹æˆä½ è‡ªå·±çš„å‘½åç©ºé—´
data:
  config.yaml: |
    telegram:
      token: "YOUR_BOT_TOKEN_HERE"          # â† æ›¿æ¢æˆçœŸå®çš„ token
      chat_id: 123456789                    # â† æ›¿æ¢æˆä½ çš„ chat ID

    http:
      listen_addr: "0.0.0.0"
      port: "80"

    maintenance:
      html_path: "/config/maintenance.html"

    switch:
      force_switch: false

      services:
        - namespace: "monitoring"
          services:
            - "frontend"           # ä½ è¦ä¿æŠ¤/åˆ‡æ¢çš„ service åå­—
            - "api-gateway"

  maintenance.html: |
    <!DOCTYPE html>
    <html lang="zh">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>ç³»ç»Ÿç»´æŠ¤ä¸­</title>
      <style>
        body {
          margin: 0;
          padding: 0;
          font-family: -apple-system, BlinkMacOSystemFont, "Segoe UI", Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          text-align: center;
        }
        .container {
          max-width: 600px;
          padding: 2rem;
        }
        h1 { font-size: 3.5rem; margin-bottom: 1rem; }
        p { font-size: 1.3rem; line-height: 1.6; }
        .emoji { font-size: 4rem; margin-bottom: 1rem; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="emoji">ğŸ› ï¸</div>
        <h1>ç³»ç»Ÿç»´æŠ¤ä¸­</h1>
        <p>æˆ‘ä»¬æ­£åœ¨è¿›è¡Œè®¡åˆ’å†…çš„ç³»ç»Ÿå‡çº§ä¸ç»´æŠ¤ï¼Œ<br/>é¢„è®¡å¾ˆå¿«å°±ä¼šæ¢å¤ã€‚</p>
        <p>ç»™æ‚¨å¸¦æ¥çš„ä¸ä¾¿æ·±è¡¨æ­‰æ„ï¼Œæ„Ÿè°¢æ‚¨çš„ç†è§£ä¸è€å¿ƒç­‰å¾…ï¼</p>
        <p style="margin-top: 3rem; font-size: 1.1rem; opacity: 0.9;">
          é¢„è®¡å®Œæˆæ—¶é—´ï¼šæ­£åœ¨å…¨åŠ›åŠ é€Ÿä¸­...<br/>
          å¦‚æœ‰ç´§æ€¥éœ€æ±‚ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ
        </p>
      </div>
    </body>
    </html>

---
# 2. Service - æš´éœ² 80 ç«¯å£ç»™ ingress / å¤–éƒ¨æµé‡
apiVersion: v1
kind: Service
metadata:
  name: traffic-switcher
  namespace: monitoring
  labels:
    app: traffic-switcher
spec:
  selector:
    app: traffic-switcher
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP

---
# 3. Deployment - æ ¸å¿ƒéƒ¨ç½²
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traffic-switcher
  namespace: monitoring
  labels:
    app: traffic-switcher
spec:
  replicas: 2                    # å»ºè®®è‡³å°‘2å‰¯æœ¬ï¼Œé˜²æ­¢å•ç‚¹
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: traffic-switcher
  template:
    metadata:
      labels:
        app: traffic-switcher
    spec:
      containers:
        - name: switcher
          image: your-registry/traffic-switcher:latest   # â† æ›¿æ¢æˆä½ è‡ªå·±çš„é•œåƒ
          imagePullPolicy: Always

          ports:
            - containerPort: 80
              name: http

          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          volumeMounts:
            - name: config-volume
              mountPath: /config
              readOnly: true

          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "300m"
              memory: "256Mi"

          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10

          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 15
            periodSeconds: 20

      volumes:
        - name: config-volume
          configMap:
            name: traffic-switcher-config
            items:
              - key: config.yaml
                path: config.yaml
              - key: maintenance.html
                path: maintenance.html

---
# 4. å¯é€‰ï¼šå¦‚æœä½¿ç”¨ Ingressï¼ˆæ¨èï¼‰
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: traffic-switcher-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # æ ¹æ®ä½ çš„ ingress-controller è°ƒæ•´
spec:
  ingressClassName: nginx
  rules:
    - host: maintenance.your-domain.com           # å¯é€‰ï¼šå¦‚æœä½ æƒ³ç”¨ç‹¬ç«‹åŸŸå
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: traffic-switcher
                port:
                  number: 80